# $Id$

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I$(srcdir)/include @CPPFLAGS@
LDFLAGS		= -Llibs @LDFLAGS@

srcdir		= @srcdir@
VPATH		= @srcdir@

RANLIB		= @RANLIB@

OBJS		= util/concat.o util/error.o util/xmalloc.o util/xwrite.o

WARNINGS	= -ansi -pedantic -Wall -W -Wunused -Wshadow \
		  -Wpointer-arith -Wbad-function-cast -Wcast-qual \
		  -Wcast-align -Wwrite-strings -Wstrict-prototypes

TESTS		= t/util/concat.t t/util/error.t t/util/xwrite.t

TESTEXTRA	= t/runtests t/xmalloc

all: libs/librutil.a

check test: $(TESTS) $(TESTEXTRA)
	cd t && ./runtests TESTS

.c.o: $*.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $*.c -o $@

libs:
	mkdir libs

libs/librutil.a: libs $(OBJS)
	ar r $@ $(OBJS)
	$(RANLIB) $@

t/runtests: t/runtests.o libs/librutil.a
	$(CC) -o $@ t/runtests.o $(LDFLAGS) -lrutil $(LIBS)

t/xmalloc: t/xmalloc.o libs/librutil.a
	$(CC) -o $@ t/xmalloc.o $(LDFLAGS) -lrutil $(LIBS)

t/util/concat.t: t/util/concat-t.o libs/librutil.a
	$(CC) -o $@ t/util/concat-t.o $(LDFLAGS) -lrutil $(LIBS)

t/util/error.t: t/util/error-t.o libs/librutil.a
	$(CC) -o $@ t/util/error-t.o $(LDFLAGS) -lrutil $(LIBS)

t/util/xwrite.t: t/util/xwrite-t.o t/fakewrite.o libs/librutil.a
	$(CC) -o $@ t/util/xwrite-t.o t/fakewrite.o $(LDFLAGS) -lrutil $(LIBS)

clean:
	rm -rf libs
	rm -f util/*.o t/*.o t/util/*.o $(TESTS) $(TESTEXTRA)

distclean: clean
	rm -f Makefile config.cache config.log config.status include/config.h
