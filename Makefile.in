# $Id$
#
# Yes, this makefile builds everything in the source tree.  Recursive make
# is inherently evil.  If your compiler doesn't support both -c and -o at
# the same time, please upgrade your compiler.

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I$(srcdir)/include @CPPFLAGS@
LDFLAGS		= -Llibs @LDFLAGS@

srcdir		= @srcdir@
VPATH		= @srcdir@

RANLIB		= @RANLIB@

OBJS		= @LIBOBJS@ \
		  util/concat.o util/error.o util/xmalloc.o util/xwrite.o

WARNINGS	= -ansi -pedantic -Wall -W -Wunused -Wshadow \
		  -Wpointer-arith -Wbad-function-cast -Wcast-qual \
		  -Wcast-align -Wwrite-strings -Wconversion \
		  -Wstrict-prototypes -Wtraditional -Werror

TESTS		= t/replace/hstrerror.t t/replace/inet_aton.t \
		  t/replace/inet_ntoa.t t/replace/memcmp.t \
		  t/replace/pread.t t/replace/pwrite.t \
		  t/replace/snprintf.t t/replace/strerror.t \
		  t/util/concat.t t/util/error.t t/util/xwrite.t

TESTEXTRA	= t/replace/setenv.tr t/runtests t/xmalloc

all: libs/librutil.a

check test: $(TESTS) $(TESTEXTRA)
	cd t && ./runtests TESTS

.c.o: $*.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $*.c -o $@

libs:
	mkdir libs

libs/librutil.a: libs $(OBJS)
	ar r $@ $(OBJS)
	$(RANLIB) $@

t/runtests: t/runtests.o
	$(CC) -o $@ t/runtests.o

t/replace/hstrerror.o: replace/hstrerror.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/hstrerror.c -o $@

t/replace/hstrerror.t: t/replace/hstrerror.o t/replace/hstrerror-t.o
	$(CC) -o $@ t/replace/hstrerror.o t/replace/hstrerror-t.o

t/replace/inet_aton.o: replace/inet_aton.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/inet_aton.c -o $@

t/replace/inet_aton.t: t/replace/inet_aton.o t/replace/inet_aton-t.o
	$(CC) -o $@ t/replace/inet_aton.o t/replace/inet_aton-t.o

t/replace/inet_ntoa.o: replace/inet_ntoa.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/inet_ntoa.c -o $@

t/replace/inet_ntoa.t: t/replace/inet_ntoa.o t/replace/inet_ntoa-t.o
	$(CC) -o $@ t/replace/inet_ntoa.o t/replace/inet_ntoa-t.o

t/replace/memcmp.o: replace/memcmp.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/memcmp.c -o $@

t/replace/memcmp.t: t/replace/memcmp.o t/replace/memcmp-t.o
	$(CC) -o $@ t/replace/memcmp.o t/replace/memcmp-t.o

t/replace/pread.o: replace/pread.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/pread.c -o $@

t/replace/pread.t: t/replace/pread.o t/replace/pread-t.o libs/librutil.a
	$(CC) -o $@ t/replace/pread.o t/replace/pread-t.o $(LDFLAGS) -lrutil

t/replace/pwrite.o: replace/pwrite.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/pwrite.c -o $@

t/replace/pwrite.t: t/replace/pwrite.o t/replace/pwrite-t.o libs/librutil.a
	$(CC) -o $@ t/replace/pwrite.o t/replace/pwrite-t.o $(LDFLAGS) -lrutil

t/replace/setenv.o: replace/setenv.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/setenv.c -o $@

t/replace/setenv.tr: t/replace/setenv.o t/replace/setenv-t.o libs/librutil.a
	$(CC) -o $@ t/replace/setenv.o t/replace/setenv-t.o $(LDFLAGS) -lrutil

t/replace/snprintf.o: replace/snprintf.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/snprintf.c -o $@

t/replace/snprintf.t: t/replace/snprintf.o t/replace/snprintf-t.o
	$(CC) -o $@ t/replace/snprintf.o t/replace/snprintf-t.o

t/replace/strerror.o: replace/strerror.c include/config.h
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/strerror.c -o $@

t/replace/strerror.t: t/replace/strerror.o t/replace/strerror-t.o
	$(CC) -o $@ t/replace/strerror.o t/replace/strerror-t.o

t/util/concat.t: t/util/concat-t.o libs/librutil.a
	$(CC) -o $@ t/util/concat-t.o $(LDFLAGS) -lrutil

t/util/error.t: t/util/error-t.o libs/librutil.a
	$(CC) -o $@ t/util/error-t.o $(LDFLAGS) -lrutil

t/xmalloc: t/xmalloc.o libs/librutil.a
	$(CC) -o $@ t/xmalloc.o $(LDFLAGS) -lrutil

t/util/xwrite.t: t/util/xwrite-t.o t/fakewrite.o libs/librutil.a
	$(CC) -o $@ t/util/xwrite-t.o t/fakewrite.o $(LDFLAGS) -lrutil

clean:
	rm -rf libs
	rm -f */*.o t/*/*.o t/util/runtests/*.result t/util/runtests/core
	rm -f $(TESTS) $(TESTEXTRA)

distclean: clean
	rm -f Makefile config.cache config.log config.status include/config.h

depend:
	./mkdepend '$(CFLAGS) $(CPPFLAGS)' `find . -type f -name '*.c' -print`
	./config.status

# DO NOT DELETE THIS LINE -- make depend depends on it.
util/concat.o: util/concat.c include/config.h include/librutil.h
util/error.o: util/error.c include/config.h include/librutil.h
util/xmalloc.o: util/xmalloc.c include/config.h include/librutil.h
util/xwrite.o: util/xwrite.c include/config.h include/librutil.h
replace/hstrerror.o: replace/hstrerror.c include/config.h
replace/inet_aton.o: replace/inet_aton.c include/config.h
replace/inet_ntoa.o: replace/inet_ntoa.c include/config.h
replace/memcmp.o: replace/memcmp.c include/config.h
replace/pread.o: replace/pread.c include/config.h
replace/pwrite.o: replace/pwrite.c include/config.h
replace/setenv.o: replace/setenv.c include/config.h
replace/strerror.o: replace/strerror.c include/config.h
replace/seteuid.o: replace/seteuid.c include/config.h
replace/snprintf.o: replace/snprintf.c include/config.h
t/util/concat-t.o: t/util/concat-t.c include/librutil.h
t/util/error-t.o: t/util/error-t.c include/config.h include/librutil.h
t/util/xwrite-t.o: t/util/xwrite-t.c include/librutil.h
t/runtests.o: t/runtests.c
t/replace/hstrerror-t.o: t/replace/hstrerror-t.c include/config.h
t/replace/strerror-t.o: t/replace/strerror-t.c include/config.h
t/replace/inet_ntoa-t.o: t/replace/inet_ntoa-t.c include/config.h
t/replace/pread-t.o: t/replace/pread-t.c include/config.h include/librutil.h
t/replace/inet_aton-t.o: t/replace/inet_aton-t.c include/config.h
t/replace/memcmp-t.o: t/replace/memcmp-t.c include/config.h
t/replace/pwrite-t.o: t/replace/pwrite-t.c include/config.h include/librutil.h
t/replace/setenv-t.o: t/replace/setenv-t.c include/config.h include/librutil.h
t/xmalloc.o: t/xmalloc.c include/librutil.h
t/fakewrite.o: t/fakewrite.c include/config.h include/librutil.h
