# $Id$
#
# Yes, this makefile builds everything in the source tree.  Recursive make
# is inherently evil.  If your compiler doesn't support both -c and -o at
# the same time, please upgrade your compiler.

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I$(srcdir)/include @CPPFLAGS@
LDFLAGS		= -Llibs @LDFLAGS@

srcdir		= @srcdir@
VPATH		= @srcdir@

RANLIB		= @RANLIB@

OBJS		= @LIBOBJS@ \
		  util/concat.o util/error.o util/xmalloc.o util/xwrite.o

WARNINGS	= -ansi -pedantic -Wall -W -Wunused -Wshadow \
		  -Wpointer-arith -Wbad-function-cast -Wcast-qual \
		  -Wcast-align -Wwrite-strings -Wconversion \
		  -Wstrict-prototypes -Wtraditional -Werror

TESTS		= t/replace/inet_aton.t t/replace/inet_ntoa.t \
		  t/replace/memcmp.t t/replace/pread.t t/replace/pwrite.t \
		  t/replace/strerror.t \
		  t/util/concat.t t/util/error.t t/util/xwrite.t

TESTEXTRA	= t/replace/setenv.tr t/runtests t/xmalloc

all: libs/librutil.a

check test: $(TESTS) $(TESTEXTRA)
	cd t && ./runtests TESTS

.c.o: $*.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $*.c -o $@

libs:
	mkdir libs

libs/librutil.a: libs $(OBJS)
	ar r $@ $(OBJS)
	$(RANLIB) $@

t/runtests: t/runtests.o libs/librutil.a
	$(CC) -o $@ t/runtests.o $(LDFLAGS) -lrutil

t/replace/inet_aton.o: replace/inet_aton.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/inet_aton.c -o $@

t/replace/inet_aton.t: t/replace/inet_aton.o t/replace/inet_aton-t.o
	$(CC) -o $@ t/replace/inet_aton.o t/replace/inet_aton-t.o

t/replace/inet_ntoa.o: replace/inet_ntoa.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/inet_ntoa.c -o $@

t/replace/inet_ntoa.t: t/replace/inet_ntoa.o t/replace/inet_ntoa-t.o
	$(CC) -o $@ t/replace/inet_ntoa.o t/replace/inet_ntoa-t.o

t/replace/memcmp.o: replace/memcmp.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/memcmp.c -o $@

t/replace/memcmp.t: t/replace/memcmp.o t/replace/memcmp-t.o
	$(CC) -o $@ t/replace/memcmp.o t/replace/memcmp-t.o

t/replace/pread.o: replace/pread.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/pread.c -o $@

t/replace/pread.t: t/replace/pread.o t/replace/pread-t.o
	$(CC) -o $@ t/replace/pread.o t/replace/pread-t.o $(LDFLAGS) -lrutil

t/replace/pwrite.o: replace/pwrite.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/pwrite.c -o $@

t/replace/pwrite.t: t/replace/pwrite.o t/replace/pwrite-t.o
	$(CC) -o $@ t/replace/pwrite.o t/replace/pwrite-t.o $(LDFLAGS) -lrutil

t/replace/setenv.o: replace/setenv.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/setenv.c -o $@

t/replace/setenv.tr: t/replace/setenv.o t/replace/setenv-t.o
	$(CC) -o $@ t/replace/setenv.o t/replace/setenv-t.o $(LDFLAGS) -lrutil

t/replace/strerror.o: replace/strerror.c
	$(CC) $(CFLAGS) -DTESTING $(CPPFLAGS) -c replace/strerror.c -o $@

t/replace/strerror.t: t/replace/strerror.o t/replace/strerror-t.o
	$(CC) -o $@ t/replace/strerror.o t/replace/strerror-t.o

t/util/concat.t: t/util/concat-t.o libs/librutil.a
	$(CC) -o $@ t/util/concat-t.o $(LDFLAGS) -lrutil

t/util/error.t: t/util/error-t.o libs/librutil.a
	$(CC) -o $@ t/util/error-t.o $(LDFLAGS) -lrutil

t/xmalloc: t/xmalloc.o libs/librutil.a
	$(CC) -o $@ t/xmalloc.o $(LDFLAGS) -lrutil

t/util/xwrite.t: t/util/xwrite-t.o t/fakewrite.o libs/librutil.a
	$(CC) -o $@ t/util/xwrite-t.o t/fakewrite.o $(LDFLAGS) -lrutil

clean:
	rm -rf libs
	rm -f util/*.o t/*.o t/*/*.o $(TESTS) $(TESTEXTRA)

distclean: clean
	rm -f Makefile config.cache config.log config.status include/config.h
